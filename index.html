<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>媛媛好订制 - 节点 JSON/YAML 转小火箭单行导出工具（支持批量）</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #FF9AA2, #FFB7B2);
      --secondary-gradient: linear-gradient(135deg, #B5EAD7, #C7CEEA);
      --accent-gradient: linear-gradient(135deg, #FFDAC1, #E2F0CB);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-shadow: rgba(181, 234, 215, 0.2);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      color: #5D4037;
      overflow-x: hidden;
      background: linear-gradient(135deg, #FFDAC1 0%, #B5EAD7 50%, #C7CEEA 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 15px;
      cursor: none;
    }

    #interactive-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.6;
    }
    
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 10;
    }
    
    .header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }
    
    .title {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #FF9AA2, #FFB7B2, #B5EAD7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      text-shadow: 2px 2px 4px rgba(255, 154, 162, 0.2);
    }
    
    .subtitle {
      color: #7E8D85;
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 15px;
    }
    
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px var(--glass-shadow);
      transition: all 0.3s ease;
    }
    
    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(181, 234, 215, 0.3);
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #5D4037;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title::before {
      content: '✨';
      font-size: 1.3rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: #7E8D85;
      font-size: 1rem;
    }

    .paste-btn {
        display: inline-block;
        margin-left: 10px;
        padding: 4px 10px;
        border: 1px solid rgba(255, 154, 162, 0.6);
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        cursor: none;
        font-size: 0.8rem;
        font-weight: 500;
        color: #5D4037;
        transition: all 0.2s ease;
    }

    .paste-btn:hover {
        background: rgba(255, 154, 162, 0.3);
        border-color: #FF9AA2;
    }
    
    textarea, input, select {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.8);
      color: #5D4037;
      font-size: 0.95rem;
      font-family: 'Fira Code', 'Consolas', monospace;
      transition: all 0.3s ease;
      resize: vertical;
    }
    
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #FF9AA2;
      box-shadow: 0 0 15px rgba(255, 154, 162, 0.3);
      background: rgba(255, 255, 255, 0.95);
    }
    
    textarea {
      min-height: 100px;
      line-height: 1.5;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      min-width: 180px;
      padding: 16px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: #5D4037;
    }
    
    .btn-secondary {
      background: var(--secondary-gradient);
      color: #5D4037;
    }
    
    .btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .output-area {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      padding: 18px;
      margin-top: 18px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .output-text {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Fira Code', 'Consolas', monospace;
      color: #4CAF50;
      min-height: 80px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid rgba(76, 175, 80, 0.3);
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .copy-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: var(--accent-gradient);
      color: #5D4037;
      border: none;
      border-radius: 8px;
      cursor: none;
      transition: all 0.3s ease;
      width: 100%;
      font-weight: 500;
    }
    
    .copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 218, 193, 0.4);
    }
    
    .node-info {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid rgba(76, 175, 80, 0.3);
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .node-info-item {
      margin-bottom: 10px;
      padding: 8px;
      border-left: 3px solid #FF9AA2;
    }
    
    .node-info-label {
      font-weight: 600;
      color: #5D4037;
      margin-right: 8px;
    }
    
    .node-info-value {
      color: #4CAF50;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.9rem;
    }
    
    .divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255, 154, 162, 0.4), transparent);
      margin: 25px 0;
      position: relative;
    }
    
    .divider::before {
      content: '⚡';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-gradient);
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 1rem;
    }
    
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px 8px 0 0;
      cursor: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab.active {
      background: var(--primary-gradient);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      gap: 15px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
      color: #7E8D85;
      font-size: 0.85rem;
    }
    
    .cursor-trail {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s ease;
    }
    
    .sparkle-trail {
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #FF9AA2 20%, transparent 70%);
      border-radius: 50%;
      animation: sparkleTrail 1.5s forwards;
      box-shadow: 0 0 15px rgba(255, 154, 162, 0.5);
    }
    
    .ribbon-trail {
      width: 40px;
      height: 8px;
      background: linear-gradient(90deg, #FF9AA2, #B5EAD7, #C7CEEA);
      border-radius: 4px;
      animation: ribbonTrail 2s forwards;
      opacity: 0.8;
    }
    
    .star-trail {
      width: 16px;
      height: 16px;
      background: radial-gradient(circle, #FFDAC1 30%, transparent 70%);
      border-radius: 50%;
      animation: starTrail 2s forwards;
      box-shadow: 0 0 12px rgba(255, 218, 193, 0.6);
    }
    
    @keyframes sparkleTrail {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.1) rotate(720deg);
      }
    }
    
    @keyframes ribbonTrail {
      0% {
        opacity: 0.8;
        transform: translate(-50%, -50%) rotate(0deg) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) rotate(180deg) scale(0.3);
      }
    }
    
    @keyframes starTrail {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(
          calc(-50% + (Math.random() - 0.5) * 100px),
          calc(-50% + (Math.random() - 0.5) * 100px)
        ) scale(0.1);
      }
    }
    
    .custom-cursor {
      position: fixed;
      width: 8px;
      height: 8px;
      background: #FF9AA2;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      transition: transform 0.1s ease;
      box-shadow: 0 0 10px rgba(255, 154, 162, 0.8);
    }
    
    .cursor-ring {
      position: fixed;
      width: 35px;
      height: 35px;
      border: 2px solid rgba(255, 154, 162, 0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      transition: all 0.2s ease-out;
    }
    
    .success-animation {
      animation: successPulse 0.4s ease-in-out;
    }
    
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
      }
      
      .title {
        font-size: 2.2rem;
      }
      
      .glass-card {
        padding: 20px;
        margin-bottom: 15px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .stats {
        flex-direction: column;
        gap: 12px;
      }
      
      body {
        cursor: auto;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <canvas id="interactive-bg"></canvas>
  <div class="custom-cursor" id="customCursor"></div>
  <div class="cursor-ring" id="cursorRing"></div>
  
  <div class="app-container">
    <div class="header">
      <h1 class="title">✨ 媛媛好订制 ✨</h1>
      <p class="subtitle">专属马卡龙风格工具 · JSON/YAML 节点一键转小火箭</p>
    </div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('single')">单个转换</div>
      <div class="tab" onclick="switchTab('batch')">批量转换</div>
    </div>

    <div class="tab-content active" id="single-tab">
      <div class="glass-card">
        <h2 class="card-title">单个节点转换</h2>
        
        <div class="form-group">
          <label for="inputText">
            节点 JSON 或 YAML 输入：
            <button class="paste-btn" onclick="pasteFromClipboard('inputText')">📋 粘贴</button>
          </label>
          <textarea id="inputText" rows="6" placeholder='粘贴 JSON 或 YAML 单个节点配置...'></textarea>
        </div>

        <div class="form-group">
          <label for="protocol">协议类型：</label>
          <select id="protocol">
            <option value="">自动识别</option>
            <option value="anytls">anytls</option>
            <option value="vless">VLESS</option>
            <option value="vmess">VMess</option>
            <option value="trojan">Trojan</option>
            <option value="ss">Shadowsocks</option>
            <option value="hy2">Hysteria2</option>
          </select>
        </div>

        <div class="form-group">
          <label for="customTag">节点备注名：</label>
          <input id="customTag" type="text" placeholder="例如：美国-01 | 手动修改" />
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="processInput()">
            🚀 生成单个节点
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            🧹 清除内容
          </button>
        </div>

        <div class="output-area">
          <label>输出结果：</label>
          <div class="output-text" id="output"></div>
          <button class="copy-btn" onclick="copyOutput('output')">
            📋 复制到剪贴板
          </button>
        </div>

        <div class="node-info" id="nodeInfo"></div>
      </div>
    </div>

    <div class="tab-content" id="batch-tab">
      <div class="glass-card">
        <h2 class="card-title">批量节点转换</h2>
        
        <div class="form-group">
          <label for="batchInput">
            批量节点输入：
            <button class="paste-btn" onclick="pasteFromClipboard('batchInput')">📋 粘贴</button>
          </label>
          <textarea id="batchInput" rows="6" placeholder='粘贴多个 YAML/JSON 节点配置...（支持 - {...} 列表/多行 JSON/YAML）'></textarea>
        </div>

        <div class="form-group">
          <label for="batchProtocol">批量协议类型：</label>
          <select id="batchProtocol">
            <option value="">自动识别</option>
            <option value="anytls">anytls</option>
            <option value="vless">VLESS</option>
            <option value="vmess">VMess</option>
            <option value="trojan">Trojan</option>
            <option value="ss">Shadowsocks</option>
            <option value="hy2">Hysteria2</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="processBatch()">
            ⚡ 批量转换
          </button>
          <button class="btn btn-secondary" onclick="clearBatch()">
            🧹 清除批量
          </button>
        </div>

        <div class="output-area">
          <label>批量输出结果：</label>
          <div class="output-text" id="batchOutput"></div>
          <button class="copy-btn" onclick="copyOutput('batchOutput')">
            📋 复制全部结果
          </button>
        </div>

        <div class="node-info" id="batchNodeInfo"></div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalConverted">0</div>
        <div class="stat-label">总转换次数</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="successRate">100%</div>
        <div class="stat-label">成功率</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="activeUsers">1</div>
        <div class="stat-label">当前用户</div>
      </div>
    </div>
  </div>

  <script>
    // ========= 鼠标拖尾效果 =========
    const cursor = document.getElementById('customCursor');
    const cursorRing = document.getElementById('cursorRing');
    let mouseX = 0;
    let mouseY = 0;
    let ringX = 0;
    let ringY = 0;

    function moveCursor(e) {
      mouseX = e.clientX;
      mouseY = e.clientY;
      cursor.style.left = mouseX + 'px';
      cursor.style.top = mouseY + 'px';
    }

    function moveCursorRing() {
      const diffX = mouseX - ringX;
      const diffY = mouseY - ringY;
      ringX += diffX * 0.15;
      ringY += diffY * 0.15;
      cursorRing.style.left = ringX + 'px';
      cursorRing.style.top = ringY + 'px';
      requestAnimationFrame(moveCursorRing);
    }

    function createSparkleTrail(x, y) {
      const sparkle = document.createElement('div');
      sparkle.className = 'cursor-trail sparkle-trail';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      document.body.appendChild(sparkle);
      
      setTimeout(() => {
        sparkle.remove();
      }, 1500);
    }

    function createRibbonTrail(x, y) {
      const ribbon = document.createElement('div');
      ribbon.className = 'cursor-trail ribbon-trail';
      ribbon.style.left = x + 'px';
      ribbon.style.top = y + 'px';
      document.body.appendChild(ribbon);
      
      setTimeout(() => {
        ribbon.remove();
      }, 2000);
    }

    function createStarTrail(x, y) {
      const star = document.createElement('div');
      star.className = 'cursor-trail star-trail';
      star.style.left = x + 'px';
      star.style.top = y + 'px';
      document.body.appendChild(star);
      
      setTimeout(() => {
        star.remove();
      }, 2000);
    }

    function initMouseEffects() {
      let lastTime = 0;
      
      document.addEventListener('mousemove', (e) => {
        moveCursor(e);
        
        const now = Date.now();
        if (now - lastTime > 50) {
          lastTime = now;
          
          const effectType = Math.floor(Math.random() * 3);
          switch(effectType) {
            case 0:
              createSparkleTrail(e.clientX + (Math.random() - 0.5) * 20, e.clientY + (Math.random() - 0.5) * 20);
              break;
            case 1:
              createRibbonTrail(e.clientX, e.clientY);
              break;
            case 2:
              createStarTrail(e.clientX + (Math.random() - 0.5) * 15, e.clientY + (Math.random() - 0.5) * 15);
              break;
          }
        }
      });

      const buttons = document.querySelectorAll('.btn, .copy-btn, .tab, .paste-btn');
      buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
          cursorRing.style.transform = 'scale(1.5)';
          cursorRing.style.borderColor = '#FF9AA2';
        });
        
        btn.addEventListener('mouseleave', () => {
          cursorRing.style.transform = 'scale(1)';
          cursorRing.style.borderColor = 'rgba(255, 154, 162, 0.6)';
        });
      });

      moveCursorRing();
    }

    function initInteractiveBackground() {
      const canvas = document.getElementById('interactive-bg');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let width = canvas.width = window.innerWidth;
      let height = canvas.height = window.innerHeight;
      
      window.addEventListener('resize', () => {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      });

      const mouse = { x: width / 2, y: height / 2 };
      window.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      });

      class Ball {
        constructor(x, y, r, color) {
          this.x = x; this.y = y; this.r = r;
          this.vx = (Math.random() - 0.5) * 2;
          this.vy = (Math.random() - 0.5) * 2;
          this.color = color;
        }

        update() {
          this.x += this.vx; this.y += this.vy;
          if (this.x < this.r || this.x > width - this.r) this.vx *= -1;
          if (this.y < this.r || this.y > height - this.r) this.vy *= -1;

          let dx = mouse.x - this.x;
          let dy = mouse.y - this.y;
          let dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 150) {
              this.x -= dx * 0.02; this.y -= dy * 0.02;
          }
        }
      }

      const balls = [
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(255, 154, 162, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(181, 234, 215, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(199, 206, 234, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(255, 218, 193, 0.5)')
      ];

      function animate() {
        ctx.clearRect(0, 0, width, height);
        ctx.filter = 'blur(30px) contrast(20)';
        balls.forEach(ball => {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            ball.update();
        });
        requestAnimationFrame(animate);
      }
      
      animate();
    }
    
    function pasteFromClipboard(targetId) {
      const targetTextarea = document.getElementById(targetId);
      if (navigator.clipboard && navigator.clipboard.readText) {
        navigator.clipboard.readText()
          .then(text => {
            targetTextarea.value = text;
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '✅ 已粘贴!';
            setTimeout(() => {
              button.innerHTML = originalText;
            }, 1500);
          })
          .catch(err => {
            console.error('无法从剪贴板粘贴: ', err);
            alert('粘贴失败！请检查浏览器权限。');
          });
      } else {
        alert('您的浏览器不支持自动粘贴功能，请手动粘贴。');
      }
    }

    // ========= 核心功能函数 =========
    function safeB64Decode(s){ try{ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4)s+='='; return decodeURIComponent(escape(atob(s))); }catch(e){ try{return atob(s);}catch(e2){return s;} } }
    function safeB64Encode(s){ try{return btoa(unescape(encodeURIComponent(s)));}catch(e){return btoa(s);} }

    function detectProtocol(node){
      if(!node)return 'vless';
      // ⭐ 新增 anytls 类型检测
      if(node.type && node.type.toLowerCase() === 'anytls') return 'anytls';
      if(typeof node==='string'){const s=node.trim(); if(s.startsWith('ss://'))return 'ss'; if(s.startsWith('vmess://'))return 'vmess'; if(s.startsWith('vless://'))return 'vless'; if(s.startsWith('trojan://'))return 'trojan'; if(s.startsWith('hysteria2://')||s.startsWith('hy2://'))return 'hy2';}
      if(node.type&&node.type.toLowerCase()==='ss')return 'ss';
      if(node.method&&node.password)return 'ss';
      if(node.type&&node.type.toLowerCase()==='trojan')return 'trojan';
      if(node.type&&node.type.toLowerCase()==='vmess')return 'vmess';
      if(node.type&&node.type.toLowerCase()==='hysteria2')return 'hy2';
      if(node.uuid)return 'vless';
      return 'vless';
    }

    function normalizeNode(node){
      if(typeof node==='string'){ 
        const parsed=parseNodeStringToObject(node); 
        if(parsed)return parsed; 
      }
      
      return {
        tag:node.name||node.tag||"未命名节点",
        // ⭐ 将 type 传入
        type:node.type||"vless",
        uuid:node.uuid||node.id||"",
        server:node.server||node.address||node.add||"",
        server_port:node.port||node.server_port||node.p||"",
        password:node.password||node.pass||"",
        method:node.method||node.cipher||"",
        security:node.tls?.enabled?"tls":(node.security||"none"),
        transport:{
          type:node.network||node.net||node.transport?.type||"tcp",
          path:node.path||node.transport?.path||node["ws-opts"]?.path||"",
          headers:node.headers||node.transport?.headers||{Host:node.host||""},
          max_early_data: node.transport?.max_early_data,
          early_data_header_name: node.transport?.early_data_header_name
        },
        aid:node.aid||node.alterId||"0",
        flow:node.flow||"",
        tls:node.tls||{},
        reality:node.tls?.reality||node.reality||null,
        utls:node.tls?.utls||node.utls||null,
        packet_encoding:node.packet_encoding||null
      };
    }

    function parseNodeStringToObject(url) {
      try {
        if (url.startsWith('vmess://')) {
          const content = safeB64Decode(url.substring(8));
          return JSON.parse(content);
        }
      } catch (e) {
        console.error("解析节点字符串失败:", e);
      }
      return null;
    }

    function convertNode(input, tagOverride = "") {
      const protocol = document.getElementById('protocol')?.value || detectProtocol(input);
      const tag = tagOverride || document.getElementById('customTag')?.value.trim() || input.tag || input.name || "未命名节点";
      let url = '';
    
      const params = [];
      const host = input.server || input.address || input.add;
      const port = input.server_port || input.port || input.p;
      // ⭐ anytls 使用 password 字段作为 userinfo
      const password = input.password || input.uuid || input.id;
      
      const encodeParam = (key, value) => {
        if (value !== undefined && value !== null && value !== '') {
          params.push(`${key}=${encodeURIComponent(value)}`);
        }
      };
    
      if (protocol === 'ss') {
        const method = input.method || input.cipher || '';
        const userinfo = `${method}:${password}`;
        const base = safeB64Encode(userinfo);
        let pluginStr = '';
        if (input.plugin) {
          pluginStr = `/?plugin=${encodeURIComponent(input.plugin)}`;
          if (input.plugin_opts) {
            pluginStr += `%3B${encodeURIComponent(input.plugin_opts)}`;
          }
        }
        url = `ss://${base}@${host}:${port}${pluginStr}#${encodeURIComponent(tag)}`;
      
      // ⭐ 新增 anytls 协议的转换逻辑
      } else if (protocol === 'anytls') {
        encodeParam('security', 'tls');
        encodeParam('sni', input.tls?.server_name);
        // ⭐ 根据您的示例，关键是添加 insecure=1
        params.push('insecure=1');

        const paramStr = params.length ? `?${params.join('&')}` : '';
        url = `anytls://${password}@${host}:${port}${paramStr}#${encodeURIComponent(tag)}`;

      } else if (protocol === 'vless') {
        let security = input.reality?.enabled ? 'reality' : (input.tls?.enabled ? 'tls' : (input.security || 'none'));
        if (security.toLowerCase() === 'anytls') {
            security = 'tls';
        }
        
        encodeParam('security', security);
    
        if (security === 'reality') {
          encodeParam('pbk', input.reality.public_key);
          encodeParam('sid', input.reality.short_id);
          encodeParam('fp', input.utls?.fingerprint || input.tls?.utls?.fingerprint);
          encodeParam('sni', input.tls?.server_name);
        } else if (security === 'tls') {
          encodeParam('fp', input.utls?.fingerprint || input.tls?.utls?.fingerprint);
          encodeParam('sni', input.tls?.server_name);
        }
    
        encodeParam('flow', input.flow);
        
        if (input.transport?.type === 'ws') {
          encodeParam('type', 'ws');
          encodeParam('path', input.transport.path);
          if (input.transport.headers?.Host) {
            const wsHost = Array.isArray(input.transport.headers.Host) ? input.transport.headers.Host[0] : input.transport.headers.Host;
            encodeParam('host', wsHost);
          }
        }
        
        const paramStr = params.length ? `?${params.join('&')}` : '';
        const uuid = input.uuid || input.id; // VLESS 需要 UUID
        url = `vless://${uuid}@${host}:${port}${paramStr}#${encodeURIComponent(tag)}`;

      } else if (protocol === 'vmess') {
        const uuid = input.uuid || input.id;
        const node = {
          v: "2", ps: tag, add: host, port: port, id: uuid,
          aid: input.aid || "0",
          net: input.transport?.type || "tcp",
          type: "none",
          host: input.transport?.headers?.Host || "",
          path: input.transport?.path || "/",
          tls: input.security || ""
        };
        url = `vmess://${safeB64Encode(JSON.stringify(node))}`;
      } else if (protocol === 'trojan') {
        url = `trojan://${password}@${host}:${port}#${encodeURIComponent(tag)}`;
      } else if (protocol === 'hy2') {
        url = `hy2://${password}@${host}:${port}#${encodeURIComponent(tag)}`;
      }
      return url;
    }

    function displayNodeInfo(node, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      const infoHtml = `
        <div class="node-info-item">
          <span class="node-info-label">🏷️ 节点名称:</span>
          <span class="node-info-value">${node.tag || '未命名'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">🌐 服务器:</span>
          <span class="node-info-value">${node.server}:${node.server_port}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">🔑 密码/UUID:</span>
          <span class="node-info-value">${node.password || node.uuid || '无'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">🔒 协议:</span>
          <span class="node-info-value">${node.type || '未知'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">🛡️ 传输安全:</span>
          <span class="node-info-value">${node.security || 'none'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">🚀 传输协议:</span>
          <span class="node-info-value">${node.transport?.type || 'tcp'}</span>
        </div>
        ${node.transport?.path ? `
        <div class="node-info-item">
          <span class="node-info-label">📁 路径:</span>
          <span class="node-info-value">${node.transport.path}</span>
        </div>` : ''}
        ${node.tls?.server_name ? `
        <div class="node-info-item">
          <span class="node-info-label">🔍 SNI:</span>
          <span class="node-info-value">${node.tls.server_name}</span>
        </div>` : ''}
        ${(node.utls?.fingerprint || node.tls?.utls?.fingerprint) ? `
        <div class="node-info-item">
          <span class="node-info-label">📊 指纹:</span>
          <span class="node-info-value">${node.utls?.fingerprint || node.tls?.utls?.fingerprint}</span>
        </div>` : ''}
        ${node.packet_encoding ? `
        <div class="node-info-item">
          <span class="node-info-label">📦 包编码:</span>
          <span class="node-info-value">${node.packet_encoding}</span>
        </div>` : ''}
      `;
      
      container.innerHTML = infoHtml;
      container.style.display = 'block';
    }

    function parseMultipleJSON(text) {
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) {
          return parsed;
        }
        return [parsed];
      } catch (e) {
        try {
          const cleanedText = text.trim().replace(/\n\s*\n/g, '\n');
          const jsonStrings = cleanedText.split(/\}(?=\s*\{)/).map(str => {
            let jsonStr = str.trim();
            if (!jsonStr.endsWith('}')) jsonStr += '}';
            if (!jsonStr.startsWith('{')) jsonStr = '{' + jsonStr;
            return jsonStr;
          });
          
          const nodes = [];
          for (const jsonStr of jsonStrings) {
            try {
              const node = JSON.parse(jsonStr);
              nodes.push(node);
            } catch (parseError) {
              console.warn('解析JSON对象失败:', parseError, '内容:', jsonStr);
            }
          }
          
          if (nodes.length > 0) {
            return nodes;
          }
          
          throw new Error('无法解析任何JSON对象');
        } catch (fallbackError) {
          try {
            const parsed = jsyaml.load(text);
            if (Array.isArray(parsed)) {
              return parsed;
            }
            return [parsed];
          } catch (yamlError) {
            throw new Error('无法解析输入内容，请确保是有效的JSON或YAML格式');
          }
        }
      }
    }

    function processInput(){
      let text=document.getElementById('inputText').value.trim();
      if(!text){alert('请输入内容！');return;}
      let node;
      try{ 
        const parsed = parseMultipleJSON(text);
        node = Array.isArray(parsed) ? parsed[0] : parsed; 
      }catch(e){ 
        alert('输入解析失败：' + e.message);
        return;
      }
      const normalized=normalizeNode(node);
      const url=convertNode(normalized);
      document.getElementById('output').textContent=url;
      
      displayNodeInfo(normalized, 'nodeInfo');
      updateStats();
    }

    function processBatch(){
      let text=document.getElementById('batchInput').value.trim();
      if(!text){alert('请输入批量节点 YAML/JSON！');return;}
      
      let nodes;
      try{
        nodes = parseMultipleJSON(text);
      }catch(e){ 
        alert('批量输入解析失败：' + e.message); 
        return; 
      }
      
      const normalizedArr=nodes.map(n=>normalizeNode(n));
      const results=normalizedArr.map((n,idx)=>convertNode(n,n.name||n.tag||(`节点${idx+1}`)));
      document.getElementById('batchOutput').textContent=results.join("\n\n");
      
      if(normalizedArr.length > 0) {
        displayNodeInfo(normalizedArr[0], 'batchNodeInfo');
      }
      
      updateStats(nodes.length);
    }

    function copyOutput(id){ 
      const output=document.getElementById(id); 
      const text = output.textContent;
      
      if (!text) {
        alert('没有内容可复制！');
        return;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        const button = event.target;
        button.classList.add('success-animation');
        const originalText = button.innerHTML;
        button.innerHTML = '✅ 已复制！';
        
        setTimeout(() => {
          button.classList.remove('success-animation');
          button.innerHTML = originalText;
        }, 1500);
      }).catch(err => {
        console.error('复制失败:', err);
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        const button = event.target;
        button.classList.add('success-animation');
        const originalText = button.innerHTML;
        button.innerHTML = '✅ 已复制！';
        
        setTimeout(() => {
          button.classList.remove('success-animation');
          button.innerHTML = originalText;
        }, 1500);
      });
    }

    function clearAll(){ 
      document.getElementById('inputText').value=''; 
      document.getElementById('protocol').value=''; 
      document.getElementById('customTag').value=''; 
      document.getElementById('output').textContent=''; 
      document.getElementById('nodeInfo').style.display='none'; 
    }

    function clearBatch(){ 
      document.getElementById('batchInput').value=''; 
      document.getElementById('batchProtocol').value=''; 
      document.getElementById('batchOutput').textContent=''; 
      document.getElementById('batchNodeInfo').style.display='none'; 
    }

    function updateStats(count = 1) {
      const totalElement = document.getElementById('totalConverted');
      const total = parseInt(totalElement.textContent) + count;
      totalElement.textContent = total;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab:nth-child(${tabName === 'single' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // 初始化
    initMouseEffects();
    initInteractiveBackground();
  </script>
</body>
</html>