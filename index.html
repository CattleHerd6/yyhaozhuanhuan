<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åª›åª›å¥½è®¢åˆ¶ - èŠ‚ç‚¹ JSON/YAML è½¬å°ç«ç®­å•è¡Œå¯¼å‡ºå·¥å…·ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #FF9AA2, #FFB7B2);
      --secondary-gradient: linear-gradient(135deg, #B5EAD7, #C7CEEA);
      --accent-gradient: linear-gradient(135deg, #FFDAC1, #E2F0CB);
      --glass-bg: rgba(255, 255, 255, 0.25);
      --glass-border: rgba(255, 255, 255, 0.4);
      --glass-shadow: rgba(181, 234, 215, 0.2);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      color: #5D4037;
      overflow-x: hidden;
      background: linear-gradient(135deg, #FFDAC1 0%, #B5EAD7 50%, #C7CEEA 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 15px;
      cursor: none;
    }

    #interactive-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.6;
    }
    
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
      z-index: 10;
    }
    
    .header {
      text-align: center;
      margin-bottom: 25px;
      position: relative;
    }
    
    .title {
      font-size: 2.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #FF9AA2, #FFB7B2, #B5EAD7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      text-shadow: 2px 2px 4px rgba(255, 154, 162, 0.2);
    }
    
    .subtitle {
      color: #7E8D85;
      font-size: 1.1rem;
      font-weight: 400;
      margin-bottom: 15px;
    }
    
    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 18px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 6px 20px var(--glass-shadow);
      transition: all 0.3s ease;
    }
    
    .glass-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(181, 234, 215, 0.3);
    }
    
    .card-title {
      font-size: 1.6rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #5D4037;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-title::before {
      content: 'âœ¨';
      font-size: 1.3rem;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 500;
      color: #7E8D85;
      font-size: 1rem;
    }

    .paste-btn {
        display: inline-block;
        margin-left: 10px;
        padding: 4px 10px;
        border: 1px solid rgba(255, 154, 162, 0.6);
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        cursor: none;
        font-size: 0.8rem;
        font-weight: 500;
        color: #5D4037;
        transition: all 0.2s ease;
    }

    .paste-btn:hover {
        background: rgba(255, 154, 162, 0.3);
        border-color: #FF9AA2;
    }
    
    textarea, input, select {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.8);
      color: #5D4037;
      font-size: 0.95rem;
      font-family: 'Fira Code', 'Consolas', monospace;
      transition: all 0.3s ease;
      resize: vertical;
    }
    
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #FF9AA2;
      box-shadow: 0 0 15px rgba(255, 154, 162, 0.3);
      background: rgba(255, 255, 255, 0.95);
    }
    
    textarea {
      min-height: 100px;
      line-height: 1.5;
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      min-width: 180px;
      padding: 16px 25px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: none;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-align: center;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: #5D4037;
    }
    
    .btn-secondary {
      background: var(--secondary-gradient);
      color: #5D4037;
    }
    
    .btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    .output-area {
      background: rgba(255, 255, 255, 0.7);
      border-radius: 12px;
      padding: 18px;
      margin-top: 18px;
      border: 1px solid rgba(255, 255, 255, 0.8);
    }
    
    .output-text {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Fira Code', 'Consolas', monospace;
      color: #4CAF50;
      min-height: 80px;
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid rgba(76, 175, 80, 0.3);
      white-space: pre-wrap;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    
    .copy-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: var(--accent-gradient);
      color: #5D4037;
      border: none;
      border-radius: 8px;
      cursor: none;
      transition: all 0.3s ease;
      width: 100%;
      font-weight: 500;
    }
    
    .copy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 218, 193, 0.4);
    }
    
    .node-info {
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid rgba(76, 175, 80, 0.3);
      display: none;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .node-info-item {
      margin-bottom: 10px;
      padding: 8px;
      border-left: 3px solid #FF9AA2;
    }
    
    .node-info-label {
      font-weight: 600;
      color: #5D4037;
      margin-right: 8px;
    }
    
    .node-info-value {
      color: #4CAF50;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 0.9rem;
    }
    
    .divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255, 154, 162, 0.4), transparent);
      margin: 25px 0;
      position: relative;
    }
    
    .divider::before {
      content: 'âš¡';
      position: absolute;
      top: -12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-gradient);
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 1rem;
    }
    
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .tab {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px 8px 0 0;
      cursor: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab.active {
      background: var(--primary-gradient);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .stats {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      gap: 15px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
    }
    
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .stat-label {
      color: #7E8D85;
      font-size: 0.85rem;
    }
    
    .cursor-trail {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: transform 0.1s ease;
    }
    
    .sparkle-trail {
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, #FF9AA2 20%, transparent 70%);
      border-radius: 50%;
      animation: sparkleTrail 1.5s forwards;
      box-shadow: 0 0 15px rgba(255, 154, 162, 0.5);
    }
    
    .ribbon-trail {
      width: 40px;
      height: 8px;
      background: linear-gradient(90deg, #FF9AA2, #B5EAD7, #C7CEEA);
      border-radius: 4px;
      animation: ribbonTrail 2s forwards;
      opacity: 0.8;
    }
    
    .star-trail {
      width: 16px;
      height: 16px;
      background: radial-gradient(circle, #FFDAC1 30%, transparent 70%);
      border-radius: 50%;
      animation: starTrail 2s forwards;
      box-shadow: 0 0 12px rgba(255, 218, 193, 0.6);
    }
    
    @keyframes sparkleTrail {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.1) rotate(720deg);
      }
    }
    
    @keyframes ribbonTrail {
      0% {
        opacity: 0.8;
        transform: translate(-50%, -50%) rotate(0deg) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) rotate(180deg) scale(0.3);
      }
    }
    
    @keyframes starTrail {
      0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(
          calc(-50% + (Math.random() - 0.5) * 100px),
          calc(-50% + (Math.random() - 0.5) * 100px)
        ) scale(0.1);
      }
    }
    
    .custom-cursor {
      position: fixed;
      width: 8px;
      height: 8px;
      background: #FF9AA2;
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      transition: transform 0.1s ease;
      box-shadow: 0 0 10px rgba(255, 154, 162, 0.8);
    }
    
    .cursor-ring {
      position: fixed;
      width: 35px;
      height: 35px;
      border: 2px solid rgba(255, 154, 162, 0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      transition: all 0.2s ease-out;
    }
    
    .success-animation {
      animation: successPulse 0.4s ease-in-out;
    }
    
    @keyframes successPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @media (max-width: 768px) {
      .app-container {
        padding: 15px;
      }
      
      .title {
        font-size: 2.2rem;
      }
      
      .glass-card {
        padding: 20px;
        margin-bottom: 15px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        min-width: 100%;
      }
      
      .stats {
        flex-direction: column;
        gap: 12px;
      }
      
      body {
        cursor: auto;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
  <canvas id="interactive-bg"></canvas>
  <div class="custom-cursor" id="customCursor"></div>
  <div class="cursor-ring" id="cursorRing"></div>
  
  <div class="app-container">
    <div class="header">
      <h1 class="title">âœ¨ åª›åª›å¥½è®¢åˆ¶ âœ¨</h1>
      <p class="subtitle">ä¸“å±é©¬å¡é¾™é£æ ¼å·¥å…· Â· JSON/YAML èŠ‚ç‚¹ä¸€é”®è½¬å°ç«ç®­</p>
    </div>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('single')">å•ä¸ªè½¬æ¢</div>
      <div class="tab" onclick="switchTab('batch')">æ‰¹é‡è½¬æ¢</div>
    </div>

    <div class="tab-content active" id="single-tab">
      <div class="glass-card">
        <h2 class="card-title">å•ä¸ªèŠ‚ç‚¹è½¬æ¢</h2>
        
        <div class="form-group">
          <label for="inputText">
            èŠ‚ç‚¹ JSON æˆ– YAML è¾“å…¥ï¼š
            <button class="paste-btn" onclick="pasteFromClipboard('inputText')">ğŸ“‹ ç²˜è´´</button>
          </label>
          <textarea id="inputText" rows="6" placeholder='ç²˜è´´ JSON æˆ– YAML å•ä¸ªèŠ‚ç‚¹é…ç½®...'></textarea>
        </div>

        <div class="form-group">
          <label for="protocol">åè®®ç±»å‹ï¼š</label>
          <select id="protocol">
            <option value="">è‡ªåŠ¨è¯†åˆ«</option>
            <option value="anytls">anytls</option>
            <option value="vless">VLESS</option>
            <option value="vmess">VMess</option>
            <option value="trojan">Trojan</option>
            <option value="ss">Shadowsocks</option>
            <option value="hy2">Hysteria2</option>
          </select>
        </div>

        <div class="form-group">
          <label for="customTag">èŠ‚ç‚¹å¤‡æ³¨åï¼š</label>
          <input id="customTag" type="text" placeholder="ä¾‹å¦‚ï¼šç¾å›½-01 | æ‰‹åŠ¨ä¿®æ”¹" />
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="processInput()">
            ğŸš€ ç”Ÿæˆå•ä¸ªèŠ‚ç‚¹
          </button>
          <button class="btn btn-secondary" onclick="clearAll()">
            ğŸ§¹ æ¸…é™¤å†…å®¹
          </button>
        </div>

        <div class="output-area">
          <label>è¾“å‡ºç»“æœï¼š</label>
          <div class="output-text" id="output"></div>
          <button class="copy-btn" onclick="copyOutput('output')">
            ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿
          </button>
        </div>

        <div class="node-info" id="nodeInfo"></div>
      </div>
    </div>

    <div class="tab-content" id="batch-tab">
      <div class="glass-card">
        <h2 class="card-title">æ‰¹é‡èŠ‚ç‚¹è½¬æ¢</h2>
        
        <div class="form-group">
          <label for="batchInput">
            æ‰¹é‡èŠ‚ç‚¹è¾“å…¥ï¼š
            <button class="paste-btn" onclick="pasteFromClipboard('batchInput')">ğŸ“‹ ç²˜è´´</button>
          </label>
          <textarea id="batchInput" rows="6" placeholder='ç²˜è´´å¤šä¸ª YAML/JSON èŠ‚ç‚¹é…ç½®...ï¼ˆæ”¯æŒ - {...} åˆ—è¡¨/å¤šè¡Œ JSON/YAMLï¼‰'></textarea>
        </div>

        <div class="form-group">
          <label for="batchProtocol">æ‰¹é‡åè®®ç±»å‹ï¼š</label>
          <select id="batchProtocol">
            <option value="">è‡ªåŠ¨è¯†åˆ«</option>
            <option value="anytls">anytls</option>
            <option value="vless">VLESS</option>
            <option value="vmess">VMess</option>
            <option value="trojan">Trojan</option>
            <option value="ss">Shadowsocks</option>
            <option value="hy2">Hysteria2</option>
          </select>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="processBatch()">
            âš¡ æ‰¹é‡è½¬æ¢
          </button>
          <button class="btn btn-secondary" onclick="clearBatch()">
            ğŸ§¹ æ¸…é™¤æ‰¹é‡
          </button>
        </div>

        <div class="output-area">
          <label>æ‰¹é‡è¾“å‡ºç»“æœï¼š</label>
          <div class="output-text" id="batchOutput"></div>
          <button class="copy-btn" onclick="copyOutput('batchOutput')">
            ğŸ“‹ å¤åˆ¶å…¨éƒ¨ç»“æœ
          </button>
        </div>

        <div class="node-info" id="batchNodeInfo"></div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-item">
        <div class="stat-number" id="totalConverted">0</div>
        <div class="stat-label">æ€»è½¬æ¢æ¬¡æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="successRate">100%</div>
        <div class="stat-label">æˆåŠŸç‡</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="activeUsers">1</div>
        <div class="stat-label">å½“å‰ç”¨æˆ·</div>
      </div>
    </div>
  </div>

  <script>
    // ========= é¼ æ ‡æ‹–å°¾æ•ˆæœ =========
    const cursor = document.getElementById('customCursor');
    const cursorRing = document.getElementById('cursorRing');
    let mouseX = 0;
    let mouseY = 0;
    let ringX = 0;
    let ringY = 0;

    function moveCursor(e) {
      mouseX = e.clientX;
      mouseY = e.clientY;
      cursor.style.left = mouseX + 'px';
      cursor.style.top = mouseY + 'px';
    }

    function moveCursorRing() {
      const diffX = mouseX - ringX;
      const diffY = mouseY - ringY;
      ringX += diffX * 0.15;
      ringY += diffY * 0.15;
      cursorRing.style.left = ringX + 'px';
      cursorRing.style.top = ringY + 'px';
      requestAnimationFrame(moveCursorRing);
    }

    function createSparkleTrail(x, y) {
      const sparkle = document.createElement('div');
      sparkle.className = 'cursor-trail sparkle-trail';
      sparkle.style.left = x + 'px';
      sparkle.style.top = y + 'px';
      document.body.appendChild(sparkle);
      
      setTimeout(() => {
        sparkle.remove();
      }, 1500);
    }

    function createRibbonTrail(x, y) {
      const ribbon = document.createElement('div');
      ribbon.className = 'cursor-trail ribbon-trail';
      ribbon.style.left = x + 'px';
      ribbon.style.top = y + 'px';
      document.body.appendChild(ribbon);
      
      setTimeout(() => {
        ribbon.remove();
      }, 2000);
    }

    function createStarTrail(x, y) {
      const star = document.createElement('div');
      star.className = 'cursor-trail star-trail';
      star.style.left = x + 'px';
      star.style.top = y + 'px';
      document.body.appendChild(star);
      
      setTimeout(() => {
        star.remove();
      }, 2000);
    }

    function initMouseEffects() {
      let lastTime = 0;
      
      document.addEventListener('mousemove', (e) => {
        moveCursor(e);
        
        const now = Date.now();
        if (now - lastTime > 50) {
          lastTime = now;
          
          const effectType = Math.floor(Math.random() * 3);
          switch(effectType) {
            case 0:
              createSparkleTrail(e.clientX + (Math.random() - 0.5) * 20, e.clientY + (Math.random() - 0.5) * 20);
              break;
            case 1:
              createRibbonTrail(e.clientX, e.clientY);
              break;
            case 2:
              createStarTrail(e.clientX + (Math.random() - 0.5) * 15, e.clientY + (Math.random() - 0.5) * 15);
              break;
          }
        }
      });

      const buttons = document.querySelectorAll('.btn, .copy-btn, .tab, .paste-btn');
      buttons.forEach(btn => {
        btn.addEventListener('mouseenter', () => {
          cursorRing.style.transform = 'scale(1.5)';
          cursorRing.style.borderColor = '#FF9AA2';
        });
        
        btn.addEventListener('mouseleave', () => {
          cursorRing.style.transform = 'scale(1)';
          cursorRing.style.borderColor = 'rgba(255, 154, 162, 0.6)';
        });
      });

      moveCursorRing();
    }

    function initInteractiveBackground() {
      const canvas = document.getElementById('interactive-bg');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      let width = canvas.width = window.innerWidth;
      let height = canvas.height = window.innerHeight;
      
      window.addEventListener('resize', () => {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      });

      const mouse = { x: width / 2, y: height / 2 };
      window.addEventListener('mousemove', (e) => {
        mouse.x = e.clientX;
        mouse.y = e.clientY;
      });

      class Ball {
        constructor(x, y, r, color) {
          this.x = x; this.y = y; this.r = r;
          this.vx = (Math.random() - 0.5) * 2;
          this.vy = (Math.random() - 0.5) * 2;
          this.color = color;
        }

        update() {
          this.x += this.vx; this.y += this.vy;
          if (this.x < this.r || this.x > width - this.r) this.vx *= -1;
          if (this.y < this.r || this.y > height - this.r) this.vy *= -1;

          let dx = mouse.x - this.x;
          let dy = mouse.y - this.y;
          let dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 150) {
              this.x -= dx * 0.02; this.y -= dy * 0.02;
          }
        }
      }

      const balls = [
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(255, 154, 162, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(181, 234, 215, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(199, 206, 234, 0.5)'),
        new Ball(Math.random() * width, Math.random() * height, Math.random() * 50 + 50, 'rgba(255, 218, 193, 0.5)')
      ];

      function animate() {
        ctx.clearRect(0, 0, width, height);
        ctx.filter = 'blur(30px) contrast(20)';
        balls.forEach(ball => {
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
            ball.update();
        });
        requestAnimationFrame(animate);
      }
      
      animate();
    }
    
    function pasteFromClipboard(targetId) {
      const targetTextarea = document.getElementById(targetId);
      if (navigator.clipboard && navigator.clipboard.readText) {
        navigator.clipboard.readText()
          .then(text => {
            targetTextarea.value = text;
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'âœ… å·²ç²˜è´´!';
            setTimeout(() => {
              button.innerHTML = originalText;
            }, 1500);
          })
          .catch(err => {
            console.error('æ— æ³•ä»å‰ªè´´æ¿ç²˜è´´: ', err);
            alert('ç²˜è´´å¤±è´¥ï¼è¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ã€‚');
          });
      } else {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨ç²˜è´´åŠŸèƒ½ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´ã€‚');
      }
    }

    // ========= æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =========
    function safeB64Decode(s){ try{ s=s.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4)s+='='; return decodeURIComponent(escape(atob(s))); }catch(e){ try{return atob(s);}catch(e2){return s;} } }
    function safeB64Encode(s){ try{return btoa(unescape(encodeURIComponent(s)));}catch(e){return btoa(s);} }

    function detectProtocol(node){
      if(!node)return 'vless';
      // â­ æ–°å¢ anytls ç±»å‹æ£€æµ‹
      if(node.type && node.type.toLowerCase() === 'anytls') return 'anytls';
      if(typeof node==='string'){const s=node.trim(); if(s.startsWith('ss://'))return 'ss'; if(s.startsWith('vmess://'))return 'vmess'; if(s.startsWith('vless://'))return 'vless'; if(s.startsWith('trojan://'))return 'trojan'; if(s.startsWith('hysteria2://')||s.startsWith('hy2://'))return 'hy2';}
      if(node.type&&node.type.toLowerCase()==='ss')return 'ss';
      if(node.method&&node.password)return 'ss';
      if(node.type&&node.type.toLowerCase()==='trojan')return 'trojan';
      if(node.type&&node.type.toLowerCase()==='vmess')return 'vmess';
      if(node.type&&node.type.toLowerCase()==='hysteria2')return 'hy2';
      if(node.uuid)return 'vless';
      return 'vless';
    }

    function normalizeNode(node){
      if(typeof node==='string'){ 
        const parsed=parseNodeStringToObject(node); 
        if(parsed)return parsed; 
      }
      
      return {
        tag:node.name||node.tag||"æœªå‘½åèŠ‚ç‚¹",
        // â­ å°† type ä¼ å…¥
        type:node.type||"vless",
        uuid:node.uuid||node.id||"",
        server:node.server||node.address||node.add||"",
        server_port:node.port||node.server_port||node.p||"",
        password:node.password||node.pass||"",
        method:node.method||node.cipher||"",
        security:node.tls?.enabled?"tls":(node.security||"none"),
        transport:{
          type:node.network||node.net||node.transport?.type||"tcp",
          path:node.path||node.transport?.path||node["ws-opts"]?.path||"",
          headers:node.headers||node.transport?.headers||{Host:node.host||""},
          max_early_data: node.transport?.max_early_data,
          early_data_header_name: node.transport?.early_data_header_name
        },
        aid:node.aid||node.alterId||"0",
        flow:node.flow||"",
        tls:node.tls||{},
        reality:node.tls?.reality||node.reality||null,
        utls:node.tls?.utls||node.utls||null,
        packet_encoding:node.packet_encoding||null
      };
    }

    function parseNodeStringToObject(url) {
      try {
        if (url.startsWith('vmess://')) {
          const content = safeB64Decode(url.substring(8));
          return JSON.parse(content);
        }
      } catch (e) {
        console.error("è§£æèŠ‚ç‚¹å­—ç¬¦ä¸²å¤±è´¥:", e);
      }
      return null;
    }

    function convertNode(input, tagOverride = "") {
      const protocol = document.getElementById('protocol')?.value || detectProtocol(input);
      const tag = tagOverride || document.getElementById('customTag')?.value.trim() || input.tag || input.name || "æœªå‘½åèŠ‚ç‚¹";
      let url = '';
    
      const params = [];
      const host = input.server || input.address || input.add;
      const port = input.server_port || input.port || input.p;
      // â­ anytls ä½¿ç”¨ password å­—æ®µä½œä¸º userinfo
      const password = input.password || input.uuid || input.id;
      
      const encodeParam = (key, value) => {
        if (value !== undefined && value !== null && value !== '') {
          params.push(`${key}=${encodeURIComponent(value)}`);
        }
      };
    
      if (protocol === 'ss') {
        const method = input.method || input.cipher || '';
        const userinfo = `${method}:${password}`;
        const base = safeB64Encode(userinfo);
        let pluginStr = '';
        if (input.plugin) {
          pluginStr = `/?plugin=${encodeURIComponent(input.plugin)}`;
          if (input.plugin_opts) {
            pluginStr += `%3B${encodeURIComponent(input.plugin_opts)}`;
          }
        }
        url = `ss://${base}@${host}:${port}${pluginStr}#${encodeURIComponent(tag)}`;
      
      // â­ æ–°å¢ anytls åè®®çš„è½¬æ¢é€»è¾‘
      } else if (protocol === 'anytls') {
        encodeParam('security', 'tls');
        encodeParam('sni', input.tls?.server_name);
        // â­ æ ¹æ®æ‚¨çš„ç¤ºä¾‹ï¼Œå…³é”®æ˜¯æ·»åŠ  insecure=1
        params.push('insecure=1');

        const paramStr = params.length ? `?${params.join('&')}` : '';
        url = `anytls://${password}@${host}:${port}${paramStr}#${encodeURIComponent(tag)}`;

      } else if (protocol === 'vless') {
        let security = input.reality?.enabled ? 'reality' : (input.tls?.enabled ? 'tls' : (input.security || 'none'));
        if (security.toLowerCase() === 'anytls') {
            security = 'tls';
        }
        
        encodeParam('security', security);
    
        if (security === 'reality') {
          encodeParam('pbk', input.reality.public_key);
          encodeParam('sid', input.reality.short_id);
          encodeParam('fp', input.utls?.fingerprint || input.tls?.utls?.fingerprint);
          encodeParam('sni', input.tls?.server_name);
        } else if (security === 'tls') {
          encodeParam('fp', input.utls?.fingerprint || input.tls?.utls?.fingerprint);
          encodeParam('sni', input.tls?.server_name);
        }
    
        encodeParam('flow', input.flow);
        
        if (input.transport?.type === 'ws') {
          encodeParam('type', 'ws');
          encodeParam('path', input.transport.path);
          if (input.transport.headers?.Host) {
            const wsHost = Array.isArray(input.transport.headers.Host) ? input.transport.headers.Host[0] : input.transport.headers.Host;
            encodeParam('host', wsHost);
          }
        }
        
        const paramStr = params.length ? `?${params.join('&')}` : '';
        const uuid = input.uuid || input.id; // VLESS éœ€è¦ UUID
        url = `vless://${uuid}@${host}:${port}${paramStr}#${encodeURIComponent(tag)}`;

      } else if (protocol === 'vmess') {
        const uuid = input.uuid || input.id;
        const node = {
          v: "2", ps: tag, add: host, port: port, id: uuid,
          aid: input.aid || "0",
          net: input.transport?.type || "tcp",
          type: "none",
          host: input.transport?.headers?.Host || "",
          path: input.transport?.path || "/",
          tls: input.security || ""
        };
        url = `vmess://${safeB64Encode(JSON.stringify(node))}`;
      } else if (protocol === 'trojan') {
        url = `trojan://${password}@${host}:${port}#${encodeURIComponent(tag)}`;
      } else if (protocol === 'hy2') {
        url = `hy2://${password}@${host}:${port}#${encodeURIComponent(tag)}`;
      }
      return url;
    }

    function displayNodeInfo(node, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      const infoHtml = `
        <div class="node-info-item">
          <span class="node-info-label">ğŸ·ï¸ èŠ‚ç‚¹åç§°:</span>
          <span class="node-info-value">${node.tag || 'æœªå‘½å'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">ğŸŒ æœåŠ¡å™¨:</span>
          <span class="node-info-value">${node.server}:${node.server_port}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">ğŸ”‘ å¯†ç /UUID:</span>
          <span class="node-info-value">${node.password || node.uuid || 'æ— '}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">ğŸ”’ åè®®:</span>
          <span class="node-info-value">${node.type || 'æœªçŸ¥'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">ğŸ›¡ï¸ ä¼ è¾“å®‰å…¨:</span>
          <span class="node-info-value">${node.security || 'none'}</span>
        </div>
        <div class="node-info-item">
          <span class="node-info-label">ğŸš€ ä¼ è¾“åè®®:</span>
          <span class="node-info-value">${node.transport?.type || 'tcp'}</span>
        </div>
        ${node.transport?.path ? `
        <div class="node-info-item">
          <span class="node-info-label">ğŸ“ è·¯å¾„:</span>
          <span class="node-info-value">${node.transport.path}</span>
        </div>` : ''}
        ${node.tls?.server_name ? `
        <div class="node-info-item">
          <span class="node-info-label">ğŸ” SNI:</span>
          <span class="node-info-value">${node.tls.server_name}</span>
        </div>` : ''}
        ${(node.utls?.fingerprint || node.tls?.utls?.fingerprint) ? `
        <div class="node-info-item">
          <span class="node-info-label">ğŸ“Š æŒ‡çº¹:</span>
          <span class="node-info-value">${node.utls?.fingerprint || node.tls?.utls?.fingerprint}</span>
        </div>` : ''}
        ${node.packet_encoding ? `
        <div class="node-info-item">
          <span class="node-info-label">ğŸ“¦ åŒ…ç¼–ç :</span>
          <span class="node-info-value">${node.packet_encoding}</span>
        </div>` : ''}
      `;
      
      container.innerHTML = infoHtml;
      container.style.display = 'block';
    }

    function parseMultipleJSON(text) {
      try {
        const parsed = JSON.parse(text);
        if (Array.isArray(parsed)) {
          return parsed;
        }
        return [parsed];
      } catch (e) {
        try {
          const cleanedText = text.trim().replace(/\n\s*\n/g, '\n');
          const jsonStrings = cleanedText.split(/\}(?=\s*\{)/).map(str => {
            let jsonStr = str.trim();
            if (!jsonStr.endsWith('}')) jsonStr += '}';
            if (!jsonStr.startsWith('{')) jsonStr = '{' + jsonStr;
            return jsonStr;
          });
          
          const nodes = [];
          for (const jsonStr of jsonStrings) {
            try {
              const node = JSON.parse(jsonStr);
              nodes.push(node);
            } catch (parseError) {
              console.warn('è§£æJSONå¯¹è±¡å¤±è´¥:', parseError, 'å†…å®¹:', jsonStr);
            }
          }
          
          if (nodes.length > 0) {
            return nodes;
          }
          
          throw new Error('æ— æ³•è§£æä»»ä½•JSONå¯¹è±¡');
        } catch (fallbackError) {
          try {
            const parsed = jsyaml.load(text);
            if (Array.isArray(parsed)) {
              return parsed;
            }
            return [parsed];
          } catch (yamlError) {
            throw new Error('æ— æ³•è§£æè¾“å…¥å†…å®¹ï¼Œè¯·ç¡®ä¿æ˜¯æœ‰æ•ˆçš„JSONæˆ–YAMLæ ¼å¼');
          }
        }
      }
    }

    function processInput(){
      let text=document.getElementById('inputText').value.trim();
      if(!text){alert('è¯·è¾“å…¥å†…å®¹ï¼');return;}
      let node;
      try{ 
        const parsed = parseMultipleJSON(text);
        node = Array.isArray(parsed) ? parsed[0] : parsed; 
      }catch(e){ 
        alert('è¾“å…¥è§£æå¤±è´¥ï¼š' + e.message);
        return;
      }
      const normalized=normalizeNode(node);
      const url=convertNode(normalized);
      document.getElementById('output').textContent=url;
      
      displayNodeInfo(normalized, 'nodeInfo');
      updateStats();
    }

    function processBatch(){
      let text=document.getElementById('batchInput').value.trim();
      if(!text){alert('è¯·è¾“å…¥æ‰¹é‡èŠ‚ç‚¹ YAML/JSONï¼');return;}
      
      let nodes;
      try{
        nodes = parseMultipleJSON(text);
      }catch(e){ 
        alert('æ‰¹é‡è¾“å…¥è§£æå¤±è´¥ï¼š' + e.message); 
        return; 
      }
      
      const normalizedArr=nodes.map(n=>normalizeNode(n));
      const results=normalizedArr.map((n,idx)=>convertNode(n,n.name||n.tag||(`èŠ‚ç‚¹${idx+1}`)));
      document.getElementById('batchOutput').textContent=results.join("\n\n");
      
      if(normalizedArr.length > 0) {
        displayNodeInfo(normalizedArr[0], 'batchNodeInfo');
      }
      
      updateStats(nodes.length);
    }

    function copyOutput(id){ 
      const output=document.getElementById(id); 
      const text = output.textContent;
      
      if (!text) {
        alert('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶ï¼');
        return;
      }
      
      navigator.clipboard.writeText(text).then(() => {
        const button = event.target;
        button.classList.add('success-animation');
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… å·²å¤åˆ¶ï¼';
        
        setTimeout(() => {
          button.classList.remove('success-animation');
          button.innerHTML = originalText;
        }, 1500);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        const button = event.target;
        button.classList.add('success-animation');
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… å·²å¤åˆ¶ï¼';
        
        setTimeout(() => {
          button.classList.remove('success-animation');
          button.innerHTML = originalText;
        }, 1500);
      });
    }

    function clearAll(){ 
      document.getElementById('inputText').value=''; 
      document.getElementById('protocol').value=''; 
      document.getElementById('customTag').value=''; 
      document.getElementById('output').textContent=''; 
      document.getElementById('nodeInfo').style.display='none'; 
    }

    function clearBatch(){ 
      document.getElementById('batchInput').value=''; 
      document.getElementById('batchProtocol').value=''; 
      document.getElementById('batchOutput').textContent=''; 
      document.getElementById('batchNodeInfo').style.display='none'; 
    }

    function updateStats(count = 1) {
      const totalElement = document.getElementById('totalConverted');
      const total = parseInt(totalElement.textContent) + count;
      totalElement.textContent = total;
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      document.querySelector(`.tab:nth-child(${tabName === 'single' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // åˆå§‹åŒ–
    initMouseEffects();
    initInteractiveBackground();
  </script>
</body>
</html>